---
title: "Constructing the Eikosany"
output: rmarkdown::html_vignette
bibliography: eikosany.bibtex
vignette: >
  %\VignetteIndexEntry{Constructing the Eikosany}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(eikosany)
```

## Introduction
The primary reference for this package is [@narushima2019microtonality]. Some
definitions for context:

- _Microtonality_: Technically, _microtonality_ refers to musical scales with
more notes than the standard 12 notes of the Western equal-tempered scale.
However, the definition has been broadened somewhat to include scales with 12
or fewer notes, as long as they aren't identical to the Western  standard ones.
- _Harmonic spectrum_: A note has a _harmonic spectrum_ if the spectrum
consists of a fundamental frequency plus overtones that are integer multiples
of the fundamental.
- _Just intonation_: _Just intonation_ scales are designed to have intervals
that are consonant when played on musical instruments whose spectrum is
harmonic. The Eikosany is a just intonation scale. See [@sethares2013tuning]
for the mathematics of harmonic spectra and just intonation.

```{r}
# libraries
library(gmp)
library(data.table)
library(fractional)

# ratio octave reduction
BIG1 <- as.bigq(1)
BIG2 <- as.bigq(2)

octave_reduce <- function(x) {
  w <- as.numeric(x)
  
  ix <- (w > 2)
  while (any(ix)) {
    w[ix] <- w[ix] / 2
    ix <- (w > 2)
  }
  
  ix <- (w < 1)
  while (any(ix)) {
    w[ix] <- w[ix] * 2
    ix <- (w < 1)
  }

  return(w)
}

ratio2cents <- function(ratio) {
  return(log2(ratio) * 1200)
}

label2key <- function(label, scale_table) {
  as.character(scale_table[cps_label == label, .(key)])
}

label2note_number <- function(label, scale_table) {
  as.numeric(scale_table[cps_label == label, .(midi_note_number)])
}

note_number2key <- function(note_number, scale_table) {
  as.character(scale_table[
    midi_note_number == note_number,
    .(key)])
}

split_chord <- function(chord) {
  as.numeric(unlist(strsplit(chord, ":")))
}

chord2note_numbers <- function(chord, harmonics, scale) {
  notes <- split_chord(chord)
  others <- setdiff(harmonics, notes)

  note_numbers <- c()
  for (i in 1:length(notes)) {
    note <- paste(sort(union(notes[i], others)), collapse = "*")
    note_numbers <- c(note_numbers, label2note_number(note, scale))
  }
  
  return(paste(sort(note_numbers), collapse = ":"))
}

chord2keys <- function(chord, harmonics, scale) {
  note_numbers <- split_chord(chord2note_numbers(
    chord, harmonics, scale
  ))

  keys <- c()
  for (i in 1:length(note_numbers)) {
    keys <- c(keys, note_number2key(note_numbers[i], scale))
  }
  
  return(paste(keys, collapse = ":"))
}

sub_chord2note_numbers <- function(chord, scale) {
  notes <- split_chord(chord)

  note_numbers <- c()
  for (i in 1:length(notes)) {
    note <- paste(sort(setdiff(notes, notes[i])), collapse = "*")
    note_numbers <- c(note_numbers, label2note_number(note, scale))
  }
  
  return(paste(sort(note_numbers), collapse = ":"))
}

sub_chord2keys <- function(chord, scale) {
  note_numbers <- split_chord(sub_chord2note_numbers(
    chord, scale
  ))

  keys <- c()
  for (i in 1:length(note_numbers)) {
    keys <- c(keys, note_number2key(note_numbers[i], scale))
  }
  
  return(paste(keys, collapse = ":"))
}

collapse_star <- function(x) {
  paste(x, collapse = "*")
}

collapse_colon <- function(x) {
  paste(x, collapse = ":")
}

```

```{r}
harmonics <- c(1, 3, 5, 7, 9, 11)
choose <- 3
normalizer <- 15
middle_c_freq <- 440 / (2 ^ (9 / 12))

eikosany <- as.data.table(t(combn(harmonics, choose)))
scale_steps <- nrow(eikosany)

cps_label <- apply(eikosany, 1, collapse_star)
ratio <- octave_reduce(apply(eikosany, 1, prod) / normalizer)
cents <- ratio2cents(ratio)
frequency <- middle_c_freq * ratio
eikosany$cps_label <- cps_label
eikosany$ratio <- ratio
eikosany$cents <- cents
eikosany$frequency <- frequency
setkey(eikosany, frequency)
eikosany <- eikosany[, .(
  cps_label,
  ratio,
  cents,
  frequency,
  interval = cents - shift(cents)
  )]
interval_matrix <- fractional(outer(
  numerical(eikosany$ratio), numerical(eikosany$ratio), "/"
  ))

```

```{r}
middle_c_note_number <- 60
note_names <- c(
  "C ",
  "C#",
  "D ",
  "D#",
  "E ",
  "F ",
  "F#",
  "G ",
  "G#",
  "A ",
  "A#",
  "B "
)
max_note_number <- 127

keyboard_map <- data.table(midi_note_number = 0:max_note_number)
keyboard_map <- keyboard_map[, .(
  midi_note_number,
  note_name = note_names,
  octave = midi_note_number %/% 12 - 1
  )]

xlow <- middle_c_note_number + 1
xhigh <- middle_c_note_number + scale_steps
keyboard_map$frequency <- keyboard_map$cents <- keyboard_map$ratio <- NA
keyboard_map$ratio[xlow:xhigh] <- eikosany$ratio
keyboard_map$cents[xlow:xhigh] <- eikosany$cents
keyboard_map$frequency[xlow:xhigh] <- eikosany$frequency

for (i in (xlow - 1):1) {
  keyboard_map$ratio[i] <- keyboard_map$ratio[i + scale_steps] / 2
  keyboard_map$cents[i] <- keyboard_map$cents[i + scale_steps] - 1200
  keyboard_map$frequency[i] <- keyboard_map$frequency[i + scale_steps] / 2
  
}
for (i in (xhigh + 1):(max_note_number + 1)) {
  keyboard_map$ratio[i] <- keyboard_map$ratio[i + scale_steps] * 2
  keyboard_map$cents[i] <- keyboard_map$cents[i + scale_steps] + 1200
  keyboard_map$frequency[i] <- keyboard_map$frequency[i + scale_steps] * 2
  
}

keyboard_map[, .(ratio = fractional(ratio))]
print(keyboard_map)




stop()


```

```{r}
CHORD_LENGTH <- 4
chords <- as.data.table(t(combn(harmonics, CHORD_LENGTH)))
chord_label <- apply(chords, 1, collapse_colon)
chords$chord_label <- chord_label

harmonic_chords <- chords[, .(
  chord_label,
  note_numbers = ":",
  keys = ":"
  )]
for (it in 1:nrow(harmonic_chords)) {
  harmonic_chords$keys[it] <-
    chord2keys(
      harmonic_chords$chord_label[it], harmonics, eikosany
      )
  harmonic_chords$note_numbers[it] <-
    chord2note_numbers(
      harmonic_chords$chord_label[it], harmonics, eikosany
      )
  }

sub_harmonic_chords <- chords[, .(
  chord_label,
  sub_note_numbers = ":",
  sub_keys = ":")]
for (it in 1:nrow(sub_harmonic_chords)) {
  sub_harmonic_chords$sub_keys[it] <-
    sub_chord2keys(
      sub_harmonic_chords$chord_label[it], eikosany
      )
  sub_harmonic_chords$sub_note_numbers[it] <-
    sub_chord2note_numbers(
      sub_harmonic_chords$chord_label[it], eikosany
      )
  }

chord_table <- harmonic_chords[sub_harmonic_chords, on = .(chord_label)]

```

## References
