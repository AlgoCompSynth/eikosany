---
title: "Constructing the Eikosany"
output: rmarkdown::html_vignette
bibliography: eikosany.bibtex
vignette: >
  %\VignetteIndexEntry{Constructing the Eikosany}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(eikosany)
```

## Introduction
The primary reference for this package is [@narushima2019microtonality]. Some
definitions for context:

- _Microtonality_: Technically, _microtonality_ refers to musical scales with
more notes than the standard 12 notes of the Western equal-tempered scale.
However, the definition has been broadened somewhat to include scales with 12
or fewer notes, as long as they aren't identical to the Western  standard ones.
- _Harmonic spectrum_: A note has a _harmonic spectrum_ if the spectrum
consists of a fundamental frequency plus overtones that are integer multiples
of the fundamental.
- _Just intonation_: _Just intonation_ scales are designed to have intervals
that are consonant when played on musical instruments whose spectrum is
harmonic. The Eikosany is a just intonation scale. See [@sethares2013tuning]
for the mathematics of harmonic spectra and just intonation.

```{r}
library(gmp)
library(data.table)
big1 <- as.bigq(1)
big2 <- as.bigq(2)
big15 <- as.bigq(15)

octave <- function(x) {
  w <- as.bigq(x)
  
  ix <- (w > big2)
  while (any(ix)) {
    w[ix] <- w[ix] / big2
    ix <- (w > big2)
  }
  
  ix <- (w < big1)
  while (any(ix)) {
    w[ix] <- w[ix] * big2
    ix <- (w < big1)
  }

  return(w)
}

ratio2cents <- function(ratio) {
  return(log2(ratio) * 1200)
}

label2note_number <- function(label, scale_table) {
  as.numeric(scale_table[cps_label == label, .(midi_note_number)])
}

tetrad2note_numbers <- function(tetrad, harmonics, scale) {
  notes <- as.numeric(unlist(strsplit(tetrad, ":")))
  others <- setdiff(harmonics, notes)

  note_numbers <- c()
  for (i in 1:length(notes)) {
    note <- paste(sort(union(notes[i], others)), collapse = "*")
    note_numbers <- c(note_numbers, label2note_number(note, scale))
  }
  
  return(paste(sort(note_numbers), collapse = ":"))
}

sub_tetrad2note_numbers <- function(tetrad, scale) {
  notes <- as.numeric(unlist(strsplit(tetrad, ":")))

  note_numbers <- c()
  for (i in 1:length(notes)) {
    note <- paste(sort(setdiff(notes, notes[i])), collapse = "*")
    note_numbers <- c(note_numbers, label2note_number(note, scale))
  }
  
  return(paste(sort(note_numbers), collapse = ":"))
}

```

```{r}
harmonics <- c(1, 3, 5, 7, 9, 11)
middle_c <- 440 / (2 ^ (9 / 12))
eikosany <- as.data.table(t(combn(harmonics, 3)))
eikosany <- eikosany[, .(
  cps_label = paste(V1, V2, V3, sep = "*"), product = V1 * V2 * V3
  )]
eikosany <- eikosany[, .(
  cps_label, ratio = octave(as.bigq(product) / big15)
  )]
eikosany <- eikosany[, .(
  cps_label,
  ratio = as.character(ratio),
  cents = ratio2cents(as.numeric(ratio)),
  frequency = middle_c * as.numeric(ratio)
  )]
setkey(eikosany, cents)
eikosany <- eikosany[, .(
  midi_note_number = 60:79,
  cps_label,
  ratio,
  cents,
  frequency,
  interval = cents - shift(cents)
  )]
eikosany$cents <- round(eikosany$cents, 2)
eikosany$frequency <- round(eikosany$frequency, 2)
eikosany$interval <- round(eikosany$interval, 2)
print(eikosany)
```

```{r}
tetrads <- as.data.table(t(combn(harmonics, 4)))[, .(
  tetrad_label = paste(V1, V2, V3, V4, sep = ":")
  )]
harmonic_tetrads <- tetrads[, .(tetrad_label, note_numbers = ":")]
for (it in 1:nrow(harmonic_tetrads)) {
  harmonic_tetrads$note_numbers[it] <-
    tetrad2note_numbers(
      harmonic_tetrads$tetrad_label[it], harmonics, eikosany
      )
  }

sub_harmonic_tetrads <- tetrads[, .(tetrad_label, sub_note_numbers = ":")]
for (it in 1:nrow(sub_harmonic_tetrads)) {
  sub_harmonic_tetrads$sub_note_numbers[it] <-
    sub_tetrad2note_numbers(
      sub_harmonic_tetrads$tetrad_label[it], eikosany
      )
  }

```

## References
